SELECT 
	db_name() as DB_IDENTIFIER,
	(SELECT A_CLIENT_NAME FROM  dbo.TBL_CLIENTS c1 WHERE C1.A_ID = P.A_FK_CLIENT_ID GROUP BY A_CLIENT_NAME) AS Client_NAME,
	A_Program AS PROGRAM, 
	A_ID AS PROGRAM_ID,
	A_DISAGGREGATE_IMPACT AS IS_DISAGGREGATED_PROGRAM,
	CAST (P.A_START_DATE AS DATE) PROGRAM_START_DATE,
	CAST (P.A_END_DATE AS DATE)PROGRAM_END_DATE,
	DATEDIFF(MONTH,P.A_START_DATE,P.A_END_DATE) AS PROGRAM_DUARATION_IN_MONTHS,
	DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE) AS PROGRAM_DUARATION_IN_YEARS,
	DATEDIFF(MONTH, CAST (P.A_START_DATE AS DATE), GETDATE()) AS PROGRAM_AGE_MONTHS,
	(SELECT A_BASE_IMPACT FROM TBL_BASE_IMPACT BI1 WHERE BI1.A_FK_PROGRAM = P.A_ID AND A_CLASSIFICATION = 1) AS PROGRAM_PIMPACT_NAME,
	(SELECT IT.A_DESCRIPTION FROM TBL_BASE_IMPACT BI1 JOIN TBL_BASE_IMPACT_TYPE IT ON BI1.A_FK_BASE_IMPACT_TYPE=IT.A_ID WHERE BI1.A_FK_PROGRAM = P.A_ID AND A_CLASSIFICATION = 1) AS PROGRAM_PIMPACT_TYPE,
	(SELECT  CR.A_DESCRIPTION FROM TBL_PROGRAM_CURRENCY PC1 JOIN TBL_CURRENCY CR ON CR.A_ID = PC1.A_FK_CURRENCY WHERE PC1.A_FK_PROGRAM = P.A_ID AND PC1.A_DEFAULT=1) AS PROGRAM_CURRENCY,
	(SELECT COUNT(*) FROM TBL_PROJECT P1 WHERE P1.A_FK_PROGRAM = P.A_ID) As NUMBER_WORKSTREAMS,
	(SELECT COUNT(*) FROM TBL_ROADMAP RM WHERE RM.A_FK_PROGRAM = P.A_ID) as NUMBER_INITIATIVES,
	(SELECT COUNT(*) FROM TBL_ROADMAP RM WHERE RM.A_FK_PROGRAM = P.A_ID AND A_ID IN (SELECT A_FK_ROADMAP FROM TBL_IMPACT)) AS NUMBER_INITIATIVES_IMPACT_BEARING,
	(SELECT COUNT(*) FROM TBL_ROADMAP RM WHERE RM.A_FK_PROGRAM = P.A_ID AND A_ID NOT IN (SELECT A_FK_ROADMAP FROM TBL_IMPACT)) AS NUMBER_INITIATIVES_NON_IMPACT_BEARING,
	(SELECT COUNT(*) FROM TBL_ROADMAP RM WHERE RM.A_FK_PROGRAM = P.A_ID AND A_ID IN (SELECT A_FK_ROADMAP FROM TBL_IMPACT IM JOIN TBL_BASE_IMPACT BIM ON IM.A_FK_BASE_IMPACT = BIM.A_ID AND A_FINANCIAL = 1)) AS NUMBER_FINANCIAL_INITIATIVES,
	(SELECT COUNT(*) FROM TBL_ROADMAP RM WHERE RM.A_FK_PROGRAM = P.A_ID AND A_ID IN (SELECT A_FK_ROADMAP FROM TBL_IMPACT IM EXCEPT SELECT A_FK_ROADMAP FROM TBL_IMPACT IM JOIN TBL_BASE_IMPACT BIM ON IM.A_FK_BASE_IMPACT = BIM.A_ID AND A_FINANCIAL = 1)) AS NUMBER_NON_FINANCIAL_INITIATIVES,
    (SELECT COUNT(*) FROM TBL_ROADMAP RM WHERE RM.A_FK_PROGRAM = P.A_ID AND A_ID IN (SELECT A_FK_ROADMAP FROM TBL_IMPACT IM JOIN TBL_BASE_IMPACT BIM ON IM.A_FK_BASE_IMPACT = BIM.A_ID AND A_CLASSIFICATION = 1)) AS NUMBER_INITIATIVE_WITH_PIMPACT_INFLUENCE,
	(SELECT COUNT(*) FROM TBL_MILESTONE M1 WHERE M1.A_FK_PROGRAM = P.A_ID AND A_IS_DISAGGREGATED_IMPACTS = 0 AND A_FK_MILESTONE_TYPE = 1) AS NUMBER_MILESTONES,
	(SELECT COUNT(*) FROM TBL_MILESTONE M1 WHERE M1.A_FK_PROGRAM = P.A_ID AND A_IS_DISAGGREGATED_IMPACTS = 0 AND A_FK_MILESTONE_TYPE = 1 AND YEAR(A_ACTUAL) <> '1900') as NUMBER_COMPLETED_MILESTONES,
	(SELECT COUNT(*) FROM TBL_MILESTONE M1 WHERE M1.A_FK_PROGRAM = P.A_ID AND A_IS_DISAGGREGATED_IMPACTS = 0 AND A_FK_MILESTONE_TYPE = 1 AND A_ID IN (SELECT A_FK_MILESTONE FROM TBL_IMPACT )) AS NUMBER_IMPACT_BEARING_MILESTONES,
	(SELECT COUNT(*) FROM TBL_MILESTONE M1 WHERE M1.A_FK_PROGRAM = P.A_ID AND A_IS_DISAGGREGATED_IMPACTS = 0 AND A_FK_MILESTONE_TYPE = 1 AND A_ID NOT IN (SELECT A_FK_MILESTONE FROM TBL_IMPACT )) AS NUMBER_NON_IMPACT_BEARING_MILESTONES,
	(SELECT COUNT(*) FROM TBL_UDF_DEFINITIONS UD1 WHERE UD1.A_FK_PROGRAM = P.A_ID) AS NUMBER_ATTRIBUTES,
	(SELECT COUNT(*) FROM TBL_BASE_IMPACT BI1 WHERE BI1.A_FK_PROGRAM = P.A_ID) AS NUMBER_BASE_IMPACTS,
	(SELECT COUNT(*) FROM TBL_BASE_IMPACT BI1 WHERE BI1.A_FK_PROGRAM = P.A_ID AND A_CALCULATED = 1) AS NUMBER_CALC_IMPACTS,
	(SELECT COUNT(*) FROM TBL_BASE_IMPACT BI1 WHERE BI1.A_FK_PROGRAM = P.A_ID AND A_CALCULATED = 0) AS NUMBER_USER_ENTERED_IMPACTS,
	(SELECT COUNT(*) FROM TBL_BASE_IMPACT BI1 WHERE BI1.A_FK_PROGRAM = P.A_ID AND BI1.A_FK_BASE_IMPACT_TIMING = (SELECT A_ID FROM TBL_BASE_IMPACT_TIMING WHERE A_DESCRIPTION = 'Recurring')) AS NUMBER_RECURRING_IMPACTS,
	(SELECT COUNT(*) FROM TBL_BASE_IMPACT BI1 WHERE BI1.A_FK_PROGRAM = P.A_ID AND BI1.A_FK_BASE_IMPACT_TIMING = (SELECT A_ID FROM TBL_BASE_IMPACT_TIMING WHERE A_DESCRIPTION = 'One Time')) AS NUMBER_ONE_TIME_IMPACTS,
	(SELECT COUNT(*) FROM TBL_BASE_IMPACT BI1  LEFT JOIN TBL_IMPACT I1 ON  BI1.A_ID = I1.A_FK_BASE_IMPACT  AND I1.A_FK_BASE_IMPACT is NULL WHERE BI1.A_FK_PROGRAM = '7776B20F-5EB2-4D7D-9FD1-B470BE34D232') AS NUMBER_IMPACTS_IN_USE,
	(CAST((SELECT COUNT(*) FROM dbo.TBL_IMPACT I1 WHERE I1.A_FK_PROGRAM = P.A_ID AND (I1.A_PLAN_INTERCEPT IS NOT NULL OR I1.A_PLAN_SLOPE IS NOT NULL)) AS FLOAT)/IIF((SELECT COUNT(*) FROM dbo.TBL_IMPACT I1 WHERE I1.A_FK_PROGRAM = P.A_ID) != 0, CAST((SELECT COUNT(*) FROM dbo.TBL_IMPACT I1 WHERE I1.A_FK_PROGRAM = P.A_ID) AS FLOAT), 1) ) AS PERC_USED_IMPACTS,
	(SELECT COUNT(*) FROM dbo.TBL_USER M4 WHERE M4.A_FK_CLIENT_ID = p.A_FK_CLIENT_ID AND A_IS_DELETED_FLAG = 0) AS NUMBER_USERS_TOTAL,
	(SELECT COUNT(*) FROM dbo.TBL_USER M4 WHERE M4.A_FK_CLIENT_ID = p.A_FK_CLIENT_ID AND A_ENABLED = 1 AND A_IS_DELETED_FLAG = 0) AS NUMBER_USERS_ACTIVE,
	(SELECT COUNT(*) FROM dbo.TBL_USER M4 WHERE M4.A_FK_CLIENT_ID = p.A_FK_CLIENT_ID AND A_ENABLED = 0 AND A_IS_DELETED_FLAG = 0) AS NUMBER_USERS_INACTIVE,
	(SELECT BIT1.A_DESCRIPTION FROM TBL_BASE_IMPACT_TYPE BIT1 JOIN TBL_BASE_IMPACT BI1 ON BI1.A_FK_BASE_IMPACT_TYPE = BIT1.A_ID AND BI1.A_CLASSIFICATION = 1 AND BI1.A_FK_PROGRAM = P.A_ID) AS PIMACT_CLASSIFICATION,
	(SELECT BI1.A_FK_BASE_IMPACT_DIRECTION FROM TBL_BASE_IMPACT_TYPE BIT1 JOIN TBL_BASE_IMPACT BI1 ON BI1.A_FK_BASE_IMPACT_TYPE = BIT1.A_ID AND BI1.A_CLASSIFICATION = 1 AND BI1.A_FK_PROGRAM = P.A_ID) AS PIMPACT_FAVORABLE_DIFFERENCE,
	(SELECT BIF1.A_NUMERIC_FACTOR FROM TBL_BASE_IMPACT_FACTOR BIF1 JOIN TBL_BASE_IMPACT BI1 ON BI1.A_FK_BASE_IMPACT_FACTOR = BIF1.A_ID AND BI1.A_CLASSIFICATION = 1 AND BI1.A_FK_PROGRAM = P.A_ID) AS PIMPACT_FACTOR,
	-- (SELECT REPLACE(sum(ISNULL(A_PLAN_INTERCEPT,0)) + SUM(ISNULL(A_PLAN_SLOPE,0))*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_IMPACT IM JOIN TBL_BASE_IMPACT BIM ON BIM.A_ID =IM.A_FK_BASE_IMPACT AND A_CLASSIFICATION = 1 WHERE IM.A_FK_PROGRAM=P.A_ID GROUP BY IM.A_FK_PROGRAM) PL_PIMPACT_PLAN,
	-- (SELECT REPLACE(sum(ISNULL(A_UPDATE_INTERCEPT,0)) + SUM(ISNULL(A_UPDATE_INTERCEPT,0))*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_IMPACT IM JOIN TBL_BASE_IMPACT BIM ON BIM.A_ID =IM.A_FK_BASE_IMPACT AND A_CLASSIFICATION = 1 WHERE IM.A_FK_PROGRAM=P.A_ID GROUP BY IM.A_FK_PROGRAM) PL_PIMPACT_FORECAST,
	-- (SELECT REPLACE(sum(ISNULL(A_ACTUAL_INTERCEPT,0)) + SUM(ISNULL(A_ACTUAL_INTERCEPT,0))*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_IMPACT IM JOIN TBL_BASE_IMPACT BIM ON BIM.A_ID =IM.A_FK_BASE_IMPACT AND A_CLASSIFICATION = 1 WHERE IM.A_FK_PROGRAM=P.A_ID GROUP BY IM.A_FK_PROGRAM) PL_PIMPACT_IMPLEMENTED,
	(SELECT TOP (1) REPLACE(ISNULL(A_PLAN_INTERCEPT,0) + ISNULL(A_PLAN_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'EBIT') AS PL_EBIT_PLAN,
	(SELECT TOP (1) REPLACE(ISNULL(A_UPDATE_INTERCEPT,0) + ISNULL(A_UPDATE_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'EBIT') AS PL_EBIT_FORECAST,
	(SELECT TOP (1) REPLACE(ISNULL(A_ACTUAL_INTERCEPT,0) + ISNULL(A_ACTUAL_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'EBIT') AS PL_EBIT_IMPLEMENTED,
	(SELECT TOP (1) REPLACE(ISNULL(A_PLAN_INTERCEPT,0) + ISNULL(A_PLAN_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'Revenue') AS PL_REVENUE_PLAN,
	(SELECT TOP (1) REPLACE(ISNULL(A_UPDATE_INTERCEPT,0) + ISNULL(A_UPDATE_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'Revenue') AS PL_REVENUE_FORECAST,
	(SELECT TOP (1) REPLACE(ISNULL(A_ACTUAL_INTERCEPT,0) + ISNULL(A_ACTUAL_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'Revenue') AS PL_REVENUE_IMPLEMENTED,
	(SELECT TOP (1) REPLACE(ISNULL(A_PLAN_INTERCEPT,0) + ISNULL(A_PLAN_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'Cost') AS PL_COST_PLAN,
	(SELECT TOP (1) REPLACE(ISNULL(A_UPDATE_INTERCEPT,0) + ISNULL(A_UPDATE_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'Cost') AS PL_COST_FORECAST,
	(SELECT TOP (1) REPLACE(ISNULL(A_ACTUAL_INTERCEPT,0) + ISNULL(A_ACTUAL_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'Cost') AS PL_COST_IMPLEMENTED,
	(SELECT TOP (1) REPLACE(ISNULL(A_PLAN_INTERCEPT,0) + ISNULL(A_PLAN_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'FTE') AS PL_FTE_PLAN,
	(SELECT TOP (1) REPLACE(ISNULL(A_UPDATE_INTERCEPT,0) + ISNULL(A_UPDATE_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'FTE') AS PL_FTE_FORECAST,
	(SELECT TOP (1) REPLACE(ISNULL(A_ACTUAL_INTERCEPT,0) + ISNULL(A_ACTUAL_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'FTE') AS PL_FTE_IMPLEMENTED,
	(SELECT TOP (1) REPLACE(ISNULL(A_PLAN_INTERCEPT,0) + ISNULL(A_PLAN_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'Assests') AS PL_ASSETS_PLAN,
	(SELECT TOP (1) REPLACE(ISNULL(A_UPDATE_INTERCEPT,0) + ISNULL(A_UPDATE_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'Assests') AS PL_ASSETS_FORECAST,
	(SELECT TOP (1) REPLACE(ISNULL(A_ACTUAL_INTERCEPT,0) + ISNULL(A_ACTUAL_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'Assests') AS PL_ASSETS_IMPLEMENTED,
	(SELECT TOP (1) REPLACE(ISNULL(A_PLAN_INTERCEPT,0) + ISNULL(A_PLAN_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'Liability') AS PL_LIABILITY_PLAN,
	(SELECT TOP (1) REPLACE(ISNULL(A_UPDATE_INTERCEPT,0) + ISNULL(A_UPDATE_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'Liability') AS PL_LIABILITY_FORECAST,
	(SELECT TOP (1) REPLACE(ISNULL(A_PLAN_INTERCEPT,0) + ISNULL(A_PLAN_SLOPE,0)*DATEDIFF(YEAR,P.A_START_DATE,P.A_END_DATE),'.',',') FROM reporting.VIEW_ALL_IMPACT AI1 JOIN TBL_BASE_IMPACT_TYPE BIT1 ON AI1.A_FK_PROGRAM = P.A_ID AND AI1.A_FK_IMPACT_TYPE = BIT1.A_ID AND BIT1.A_DESCRIPTION = 'Liability') AS PL_LIABILITY_IMPLEMENTED








FROM TBL_PROGRAM P 